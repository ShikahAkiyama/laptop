<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katalog Laptop Ready Stock</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Inter', sans-serif; }
        .navbar { box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .hero-section { background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); color: white; padding: 80px 0; margin-bottom: 0; position: relative; overflow: hidden; }
        .hero-section::after { content: ''; position: absolute; bottom: -50px; left: 0; width: 100%; height: 100px; background: #f4f7f6; transform: skewY(-3deg); }
        .brand-header { background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; border-left: 5px solid #0d6efd; }
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 50px; }
        .table thead { background-color: #0d6efd; color: white; }
        .price-text { font-weight: bold; color: #d63031; white-space: nowrap; display: block; }
        .stock-tag { font-size: 0.8rem; font-weight: 600; }
        .card { transition: all 0.3s; border: none; border-radius: 12px; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .spec-label { font-size: 0.8rem; color: #636e72; margin-bottom: 0; }
        .wa-button { position: fixed; bottom: 20px; right: 20px; z-index: 1000; background: #25d366; color: white; border-radius: 50px; padding: 10px 20px; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .price-text:hover { background-color: #fff3cd; cursor: text; border-radius: 4px; }
        th { cursor: pointer; }
        tbody tr { cursor: pointer; transition: background-color 0.2s; }
        .card { cursor: pointer; }

        /* Navbar Auto-Hide Styles */
        body { padding-top: 80px; }
        .navbar { transition: transform 0.3s ease-in-out; }
        .navbar-hidden { transform: translateY(-100%); }

        /* Dark Mode Styles */
        body.dark-mode { background-color: #121212; color: #e0e0e0; }
        body.dark-mode .navbar { background-color: #1e1e1e !important; border-bottom: 1px solid #333; }
        body.dark-mode .bg-white { background-color: #1e1e1e !important; color: #e0e0e0; }
        body.dark-mode .card, body.dark-mode .table-container, body.dark-mode .brand-header { background-color: #1e1e1e; color: #e0e0e0; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        body.dark-mode .table { color: #e0e0e0; --bs-table-hover-color: #fff; --bs-table-hover-bg: #333; border-color: #333; }
        body.dark-mode .table thead { background-color: #06357a; }
        body.dark-mode .form-control, body.dark-mode .form-select { background-color: #2c2c2c; border-color: #444; color: #fff; }
        body.dark-mode .form-control::placeholder { color: #bbb; }
        body.dark-mode .input-group-text { background-color: #333; border-color: #444; color: #ccc !important; }
        body.dark-mode .modal-content { background-color: #1e1e1e; color: #fff; border: 1px solid #444; }
        body.dark-mode .modal-header, body.dark-mode .modal-footer { border-color: #333; }
        body.dark-mode .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        body.dark-mode .text-muted { color: #aaa !important; }
        body.dark-mode .spec-label { color: #aaa; }
        body.dark-mode .bg-light { background-color: #2c2c2c !important; }
        body.dark-mode .navbar-brand img { background: rgba(255,255,255,0.9); padding: 2px; border-radius: 4px; }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
    <div class="container">
        <a class="navbar-brand" href="#">
            <img src="assets/logo.png" alt="Logo" height="50">
        </a>
        <div class="ms-auto d-flex align-items-center">
            <button class="btn btn-outline-secondary rounded-circle me-2" id="darkModeBtn">
                <i class="bi bi-moon-fill"></i>
            </button>
            <button class="btn btn-outline-primary rounded-pill px-3 me-2 position-relative" onclick="window.openCart()">
                <i class="bi bi-cart-fill"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCount">0</span>
            </button>
            <a href="https://wa.me/628994335111" class="btn btn-success rounded-pill px-4">
                <i class="bi bi-whatsapp me-2"></i> Hubungi Kami
            </a>
        </div>
    </div>
</nav>

<header class="hero-section text-center">
    <div class="container">
        <h1 class="display-4 fw-bold mb-3">Pusat Laptop Second Berkualitas</h1>
        <p class="lead mb-4">Laptop Business Series (ThinkPad, Latitude, EliteBook) dengan kondisi terjamin, lolos QC ketat, dan bergaransi.</p>
        <a href="#katalog" class="btn btn-warning btn-lg px-5 fw-bold rounded-pill shadow">Lihat Katalog Ready Stock</a>
    </div>
</header>

<!-- Trust Section (Kenapa Memilih Kami) -->
<section class="py-5 mb-5">
    <div class="container">
        <div class="row g-4 text-center">
            <div class="col-md-4">
                <div class="p-4 bg-white rounded-4 shadow-sm h-100">
                    <i class="bi bi-shield-check text-primary display-4 mb-3"></i>
                    <h4 class="fw-bold">Quality Control Ketat</h4>
                    <p class="text-muted">Setiap unit telah melalui serangkaian tes hardware dan software untuk memastikan performa maksimal.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-4 bg-white rounded-4 shadow-sm h-100">
                    <i class="bi bi-award text-primary display-4 mb-3"></i>
                    <h4 class="fw-bold">Bergaransi Toko</h4>
                    <p class="text-muted">Kami memberikan garansi untuk memberikan rasa aman dan nyaman bagi setiap pelanggan.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-4 bg-white rounded-4 shadow-sm h-100">
                    <i class="bi bi-tags text-primary display-4 mb-3"></i>
                    <h4 class="fw-bold">Harga Terbaik</h4>
                    <p class="text-muted">Dapatkan laptop spesifikasi tinggi kelas bisnis dengan harga yang sangat terjangkau.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="container" id="katalog">

    <!-- Search Filter -->
    <div class="row mb-4 g-3 justify-content-center">
        <div class="col-md-5">
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-search"></i></span>
                <input type="text" id="searchInput" class="form-control border-start-0 border-end-0" placeholder="Cari laptop (Ex: ThinkPad, Core i5)...">
                <button class="btn bg-white border border-start-0 text-muted" type="button" id="clearSearchBtn" style="display: none;">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        <div class="col-md-2">
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-white text-muted">Min Rp</span>
                <input type="number" id="minPrice" class="form-control" placeholder="Harga Terendah">
            </div>
        </div>
        <div class="col-md-2">
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-white text-muted">Max Rp</span>
                <input type="number" id="maxPrice" class="form-control" placeholder="Harga Tertinggi">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select shadow-sm" id="sortBy">
                <option value="default">ðŸ“… Urutkan: Terbaru</option>
                <option value="price_asc">ðŸ’° Harga: Terendah</option>
                <option value="price_desc">ðŸ’Ž Harga: Tertinggi</option>
            </select>
        </div>
    </div>

    <div class="brand-header">
        <h2 class="mb-0">âœ… LENOVO THINKPAD SERIES</h2>
    </div>
    <div class="row g-4 mb-5" id="lenovoContainer">
        <!-- Data Lenovo akan masuk di sini via JS -->
    </div>

    <div class="brand-header mt-5" style="border-left-color: #0076d6;">
        <h2 class="mb-0">âœ… LAPTOP DELL LATITUDE</h2>
    </div>
    <div class="row g-4 mb-5" id="dellContainer">
        <!-- Data Dell akan masuk di sini via JS -->
    </div>

    <div class="brand-header mt-5" style="border-left-color: #000;">
        <h2 class="mb-0">âœ… LAPTOP HP (PROBOOK & ELITEBOOK)</h2>
    </div>
    <div class="row g-4 mb-5" id="hpContainer">
        <!-- Data HP akan masuk di sini via JS -->
    </div>
</div>

<footer class="bg-dark text-white pt-5 pb-4 mt-5">
    <div class="container">
        <div class="row">
            <div class="col-md-5 mb-4">
                <img src="assets/logo.png" alt="Logo" style="height: 60px; background: white; padding: 5px; border-radius: 8px; margin-bottom: 20px;">
                <p class="text-white-50">Solusi kebutuhan IT Anda. Menyediakan laptop second berkualitas, service komputer, dan sparepart dengan pelayanan terbaik di Surabaya.</p>
            </div>
            <div class="col-md-1"></div>
            <div class="col-md-6 mb-4">
                <h5 class="text-warning mb-4 fw-bold">Hubungi Kami</h5>
                <ul class="list-unstyled">
                    <li class="mb-3"><i class="bi bi-geo-alt-fill me-2 text-warning"></i> Jl. Medokan Sawah Timur Gg. 1A No. 10 Kav. 22A</li>
                    <li class="mb-3"><i class="bi bi-telephone-fill me-2 text-warning"></i> (+62) 899 4335 111</li>
                    <li class="mb-3"><i class="bi bi-envelope-fill me-2 text-warning"></i> dokterpc@servicekomputersurabaya.id</li>
                    <li class="mb-3"><i class="bi bi-globe me-2 text-warning"></i> <a href="https://servicekomputersurabaya.id" class="text-white text-decoration-none">https://servicekomputersurabaya.id</a></li>
                </ul>
            </div>
        </div>
        <hr class="border-secondary my-4">
        <div class="text-center text-white-50">
            <small>&copy; 2024 Service Komputer Surabaya. All rights reserved.</small>
        </div>
    </div>
</footer>

<a href="https://wa.me/628994335111" class="wa-button">
    <i class="bi bi-whatsapp"></i> Chat WhatsApp
</a>

<!-- Modal Detail Produk -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow border-0">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">Detail Spesifikasi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-5 text-center mb-3 mb-md-0 d-flex align-items-center justify-content-center bg-light rounded-3 position-relative" style="min-height: 200px; overflow: hidden;" id="modalImageContainer">
                        <i class="bi bi-laptop display-1 text-secondary"></i>
                    </div>
                    <div class="col-md-7">
                        <span class="badge bg-info text-dark mb-2" id="modalBrand">Brand</span>
                        <h3 class="fw-bold mb-2" id="modalModel">Model Laptop</h3>
                        <div id="modalPriceContainer" class="mb-3"></div>
                        
                        <div class="mb-4">
                            <span id="modalStock" class="badge bg-primary">Stock: 0</span>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-6">
                                <small class="text-muted d-block text-uppercase" style="font-size: 0.75rem;">Processor</small>
                                <strong id="modalProcessor">-</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block text-uppercase" style="font-size: 0.75rem;">RAM / Storage</small>
                                <strong id="modalRamStorage">-</strong>
                            </div>
                            <div class="col-12">
                                <small class="text-muted d-block text-uppercase" style="font-size: 0.75rem;">Layar & Fitur</small>
                                <strong id="modalFeatures">-</strong>
                            </div>
                            <div class="col-12 d-none" id="modalMiscRow">
                                <small class="text-muted d-block text-uppercase" style="font-size: 0.75rem;">Lain-lain</small>
                                <strong id="modalMisc">-</strong>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary btn-lg rounded-pill shadow-sm" id="modalAddToCartBtn">
                                <i class="bi bi-cart-plus me-2"></i> Tambah ke Keranjang
                            </button>
                            <a href="#" id="modalWaBtn" target="_blank" class="btn btn-success btn-lg rounded-pill shadow-sm">
                                <i class="bi bi-whatsapp me-2"></i> Pesan Sekarang
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Keranjang Belanja -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 shadow border-0">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Keranjang Belanja</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div id="cartItemsContainer">
                    <!-- Item keranjang akan dirender di sini -->
                </div>
                <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                    <h4 class="fw-bold">Total:</h4>
                    <h4 class="fw-bold text-danger" id="cartTotal">Rp 0</h4>
                </div>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-success rounded-pill px-4" onclick="window.checkoutCart()">
                    <i class="bi bi-whatsapp me-2"></i> Checkout via WA
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifikasi -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="cartToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">Berhasil ditambahkan ke keranjang!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Dark Mode Logic
    const darkModeBtn = document.getElementById('darkModeBtn');
    const body = document.body;
    const icon = darkModeBtn.querySelector('i');

    // Check Local Storage on Load
    if (localStorage.getItem('darkMode') === 'enabled') {
        enableDarkMode();
    }

    darkModeBtn.addEventListener('click', () => {
        if (body.classList.contains('dark-mode')) {
            disableDarkMode();
        } else {
            enableDarkMode();
        }
    });

    function enableDarkMode() {
        body.classList.add('dark-mode');
        icon.classList.replace('bi-moon-fill', 'bi-sun-fill');
        localStorage.setItem('darkMode', 'enabled');
    }

    function disableDarkMode() {
        body.classList.remove('dark-mode');
        icon.classList.replace('bi-sun-fill', 'bi-moon-fill');
        localStorage.setItem('darkMode', 'disabled');
    }

    // Navbar Auto Hide/Show Logic
    let lastScrollTop = 0;
    const navbar = document.querySelector('.navbar');

    window.addEventListener('scroll', function() {
        let scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        if (scrollTop > lastScrollTop && scrollTop > 80) {
            navbar.classList.add('navbar-hidden');
        } else {
            navbar.classList.remove('navbar-hidden');
        }
        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
    });
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCvwo1qhS9ugnweRccAP0Wgvk1MQ2XBdXg",
        authDomain: "laptop-e718c.firebaseapp.com",
        projectId: "laptop-e718c",
        storageBucket: "laptop-e718c.firebasestorage.app",
        messagingSenderId: "21040544479",
        appId: "1:21040544479:web:67549dc570d07f3544076a",
        measurementId: "G-SP2R77RD68"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allLaptops = []; // Menyimpan data untuk fitur pencarian
    let cart = JSON.parse(localStorage.getItem('shoppingCart')) || []; // Data Keranjang

    // Fungsi Format Rupiah
    const formatRupiah = (num) => {
        return "Rp " + num.toLocaleString('id-ID');
    };

    // Fungsi Render Card (Khusus Dell & HP)
    const renderCard = (data) => {
        const stockBadge = data.stock < 5 ? 'bg-danger' : 'bg-primary';
        
        let priceHtml = `<span class="price-text">${formatRupiah(data.price)}</span>`;
        let discountBadge = '';

        if (data.originalPrice && data.originalPrice > data.price) {
            const discount = Math.round(((data.originalPrice - data.price) / data.originalPrice) * 100);
            priceHtml = `<div class="d-flex flex-column align-items-start"><s class="text-muted small">${formatRupiah(data.originalPrice)}</s> <span class="price-text">${formatRupiah(data.price)}</span></div>`;
            discountBadge = `<span class="position-absolute top-0 end-0 badge bg-danger m-3 shadow">Hemat ${discount}%</span>`;
        }

        return `
            <div class="col-md-4" onclick="window.openDetail('${data.id}')">
                <div class="card h-100 p-3 position-relative">
                    ${discountBadge}
                    <h5>${data.model}</h5>
                    <p class="spec-label">${data.processor} | ${data.ram} | ${data.storage}</p>
                    <p class="small">${data.features}</p>
                    <div class="mt-auto d-flex justify-content-between align-items-center">
                        ${priceHtml}
                        <span class="badge ${stockBadge}">${data.stock} Unit</span>
                    </div>
                </div>
            </div>
        `;
    };

    // Fungsi Render Data ke HTML
    const renderLaptops = (laptops) => {
        const lenovoContainer = document.getElementById('lenovoContainer');
        const dellContainer = document.getElementById('dellContainer');
        const hpContainer = document.getElementById('hpContainer');

        // Reset Container
        lenovoContainer.innerHTML = '';
        dellContainer.innerHTML = '';
        hpContainer.innerHTML = '';

        laptops.forEach(data => {
            const brand = data.brand.toLowerCase();
            if (brand.includes('lenovo')) {
                lenovoContainer.innerHTML += renderCard(data);
            } else if (brand.includes('dell')) {
                dellContainer.innerHTML += renderCard(data);
            } else if (brand.includes('hp')) {
                hpContainer.innerHTML += renderCard(data);
            }
        });

        // Pesan jika kosong
        if (lenovoContainer.innerHTML === '') lenovoContainer.innerHTML = '<div class="col-12 text-center text-muted py-3">Tidak ada data yang cocok</div>';
        if (dellContainer.innerHTML === '') dellContainer.innerHTML = '<div class="col-12 text-center text-muted py-3">Tidak ada data yang cocok</div>';
        if (hpContainer.innerHTML === '') hpContainer.innerHTML = '<div class="col-12 text-center text-muted py-3">Tidak ada data yang cocok</div>';
    };

    // Load Data dari Firebase
    async function loadLaptops() {
        const loadingSpinnerDiv = `
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>`;

        document.getElementById('lenovoContainer').innerHTML = loadingSpinnerDiv;
        document.getElementById('dellContainer').innerHTML = loadingSpinnerDiv;
        document.getElementById('hpContainer').innerHTML = loadingSpinnerDiv;

        const q = query(collection(db, "laptops"), orderBy("price", "asc"));
        const querySnapshot = await getDocs(q);

        allLaptops = [];
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            data.id = doc.id; // Simpan ID dokumen untuk keperluan modal
            // Cek Status: Jika 'inactive', jangan ditampilkan.
            if (data.status === 'inactive') return;
            allLaptops.push(data);
        });

        renderLaptops(allLaptops);
    }

    // Fungsi Filter Gabungan (Search + Price)
    const applyFilters = () => {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const minPrice = Number(document.getElementById('minPrice').value) || 0;
        const maxPrice = Number(document.getElementById('maxPrice').value) || Infinity;
        const sortValue = document.getElementById('sortBy').value;

        let filtered = allLaptops.filter(item => {
            const searchStr = `${item.brand} ${item.model} ${item.processor} ${item.ram} ${item.storage} ${item.features}`.toLowerCase();
            const matchKeyword = searchStr.includes(keyword);
            const matchPrice = item.price >= minPrice && item.price <= maxPrice;
            return matchKeyword && matchPrice;
        });

        // Sorting Logic
        if (sortValue === 'price_asc') {
            filtered.sort((a, b) => a.price - b.price);
        } else if (sortValue === 'price_desc') {
            filtered.sort((a, b) => b.price - a.price);
        }

        renderLaptops(filtered);
    };

    // Fungsi Buka Modal Detail
    window.openDetail = (id) => {
        const laptop = allLaptops.find(l => l.id === id);
        if (!laptop) return;

        // Isi data ke modal
        document.getElementById('modalBrand').innerText = laptop.brand;
        document.getElementById('modalModel').innerText = laptop.model;
        
        if (laptop.originalPrice && laptop.originalPrice > laptop.price) {
            const discount = Math.round(((laptop.originalPrice - laptop.price) / laptop.originalPrice) * 100);
            document.getElementById('modalPriceContainer').innerHTML = `
                <div class="d-flex align-items-center gap-2 mb-1">
                    <span class="badge bg-danger">Diskon ${discount}%</span>
                    <h5 class="text-muted text-decoration-line-through mb-0">${formatRupiah(laptop.originalPrice)}</h5>
                </div>
                <h3 class="text-danger fw-bold">${formatRupiah(laptop.price)}</h3>`;
        } else {
            document.getElementById('modalPriceContainer').innerHTML = `<h3 class="text-danger fw-bold">${formatRupiah(laptop.price)}</h3>`;
        }

        document.getElementById('modalProcessor').innerText = laptop.processor;
        document.getElementById('modalRamStorage').innerText = `${laptop.ram} / ${laptop.storage}`;
        document.getElementById('modalFeatures').innerText = laptop.features;
        
        const miscRow = document.getElementById('modalMiscRow');
        if (laptop.misc && laptop.misc.trim() !== '') {
            document.getElementById('modalMisc').innerText = laptop.misc;
            miscRow.classList.remove('d-none');
        } else {
            miscRow.classList.add('d-none');
        }
        
        // Render Images (Carousel or Single Image)
        const imgContainer = document.getElementById('modalImageContainer');
        if (laptop.images && laptop.images.length > 0) {
            if (laptop.images.length === 1) {
                imgContainer.innerHTML = `<img src="${laptop.images[0]}" class="img-fluid rounded-3" style="max-height: 300px; object-fit: contain;">`;
            } else {
                // Bootstrap Carousel
                let indicators = '';
                let items = '';
                laptop.images.forEach((img, idx) => {
                    const active = idx === 0 ? 'active' : '';
                    indicators += `<button type="button" data-bs-target="#productCarousel" data-bs-slide-to="${idx}" class="${active}"></button>`;
                    items += `<div class="carousel-item ${active}"><img src="${img}" class="d-block w-100 rounded-3" style="height: 300px; object-fit: contain;"></div>`;
                });
                
                imgContainer.innerHTML = `
                    <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-indicators">${indicators}</div>
                        <div class="carousel-inner">${items}</div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span></button>
                        <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span></button>
                    </div>`;
            }
        } else {
            imgContainer.innerHTML = `<i class="bi bi-laptop display-1 text-secondary"></i>`;
        }

        const stockBadge = document.getElementById('modalStock');
        stockBadge.innerText = `Stok: ${laptop.stock} Unit`;
        stockBadge.className = `badge ${laptop.stock < 5 ? 'bg-danger' : 'bg-primary'}`;

        // Update Link WhatsApp
        const message = `Halo, saya tertarik dengan laptop ${laptop.brand} ${laptop.model} seharga ${formatRupiah(laptop.price)}. Apakah barangnya masih ready?`;
        document.getElementById('modalWaBtn').href = `https://wa.me/628994335111?text=${encodeURIComponent(message)}`;

        // Setup Tombol Tambah ke Keranjang
        const addToCartBtn = document.getElementById('modalAddToCartBtn');
        addToCartBtn.onclick = () => window.addToCart(id);

        // Tampilkan Modal
        const myModal = new bootstrap.Modal(document.getElementById('productModal'));
        myModal.show();
    };

    // Event Listeners
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');

    searchInput.addEventListener('keyup', () => {
        applyFilters();
        clearSearchBtn.style.display = searchInput.value ? 'block' : 'none';
    });
    clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        applyFilters();
        searchInput.focus();
    });

    document.getElementById('minPrice').addEventListener('input', applyFilters);
    document.getElementById('maxPrice').addEventListener('input', applyFilters);
    document.getElementById('sortBy').addEventListener('change', applyFilters);

    // --- LOGIKA KERANJANG BELANJA ---

    const updateCartCount = () => {
        const count = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
        document.getElementById('cartCount').innerText = count;
    };

    window.addToCart = (id) => {
        const laptop = allLaptops.find(l => l.id === id);
        if (laptop) {
            const existingItem = cart.find(item => item.id === id);
            if (existingItem) {
                existingItem.qty = (existingItem.qty || 1) + 1;
            } else {
                cart.push({ ...laptop, qty: 1 });
            }
            localStorage.setItem('shoppingCart', JSON.stringify(cart));
            updateCartCount();
            
            // Tutup modal produk & Tampilkan Toast
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            const toast = new bootstrap.Toast(document.getElementById('cartToast'));
            toast.show();
        }
    };

    // Fungsi Render UI Keranjang (Tanpa manipulasi Modal)
    const renderCartUI = () => {
        const container = document.getElementById('cartItemsContainer');
        container.innerHTML = '';
        let total = 0;

        if (cart.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-cart-x display-1"></i><p class="mt-3">Keranjang masih kosong</p></div>';
        } else {
            // Tombol Hapus Semua
            const clearBtn = document.createElement('div');
            clearBtn.className = 'd-flex justify-content-end mb-2';
            clearBtn.innerHTML = `<button class="btn btn-sm btn-outline-danger" onclick="window.clearCart()">Hapus Semua</button>`;
            container.appendChild(clearBtn);

            const table = document.createElement('table');
            table.className = 'table align-middle mb-0';
            table.innerHTML = `<thead><tr><th>Produk</th><th style="width: 80px;">Qty</th><th class="text-end">Total</th><th class="text-end"></th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');

            cart.forEach((item, index) => {
                const qty = item.qty || 1;
                const subtotal = item.price * qty;
                total += subtotal;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <span class="badge bg-secondary mb-1">${item.brand}</span><br>
                        <strong>${item.model}</strong><br>
                        <small class="text-muted">@ ${formatRupiah(item.price)}</small>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" value="${qty}" min="1" onchange="window.updateQty(${index}, this.value)">
                    </td>
                    <td class="text-end text-nowrap">${formatRupiah(subtotal)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger rounded-circle" onclick="window.removeFromCart(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            container.appendChild(table);
        }

        document.getElementById('cartTotal').innerText = formatRupiah(total);
    };

    window.updateQty = (index, value) => {
        let newQty = parseInt(value);
        if (isNaN(newQty) || newQty < 1) newQty = 1;
        cart[index].qty = newQty;
        localStorage.setItem('shoppingCart', JSON.stringify(cart));
        updateCartCount();
        renderCartUI(); // Hanya update tampilan, jangan panggil openCart()
    };

    window.clearCart = () => {
        if (confirm('Yakin ingin mengosongkan keranjang?')) {
            cart = [];
            localStorage.setItem('shoppingCart', JSON.stringify(cart));
            updateCartCount();
            renderCartUI(); // Hanya update tampilan
            
            // Tutup modal otomatis
            const modalEl = document.getElementById('cartModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
        }
    };

    window.removeFromCart = (index) => {
        cart.splice(index, 1);
        localStorage.setItem('shoppingCart', JSON.stringify(cart));
        updateCartCount();
        renderCartUI(); // Hanya update tampilan

        // Tutup modal jika kosong
        if (cart.length === 0) {
            const modalEl = document.getElementById('cartModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
        }
    };

    window.openCart = () => {
        renderCartUI();
        // Gunakan getOrCreateInstance agar instance modal tidak menumpuk (penyebab layar stuck)
        const modalEl = document.getElementById('cartModal');
        const cartModal = bootstrap.Modal.getOrCreateInstance(modalEl);
        cartModal.show();
    };

    window.checkoutCart = () => {
        if (cart.length === 0) return;

        let message = "Halo, saya ingin memesan laptop berikut:\n\n";
        let total = 0;
        cart.forEach((item, index) => {
            const qty = item.qty || 1;
            const subtotal = item.price * qty;
            message += `${index + 1}. ${item.brand} ${item.model} (${qty} unit) - ${formatRupiah(subtotal)}\n`;
            total += subtotal;
        });
        message += `\nTotal: ${formatRupiah(total)}\n\nApakah stoknya ready?`;

        window.open(`https://wa.me/628994335111?text=${encodeURIComponent(message)}`, '_blank');
    };

    // Jalankan saat halaman dimuat
    loadLaptops();
    updateCartCount(); // Init cart count
</script>
</body>
</html>